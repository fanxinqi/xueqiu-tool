# 雪球爬虫插件 - 状态持久化功能说明

## 🎯 功能概述

该Chrome插件现在支持跨浏览器标签页的状态持久化，确保爬虫状态在tab切换时保持一致。

## 🔧 核心功能

### 1. 状态自动保存
- 爬虫启动/停止时自动保存状态
- 数据收集过程中实时更新状态
- 状态包含：运行状态、收集的数据、当前页面数、最后更新时间

### 2. 跨Tab状态同步
- 切换tab时自动检测状态变化
- 新打开的雪球页面会自动恢复之前的状态
- 支持多个tab之间的状态同步

### 3. 状态有效性管理
- 状态有5分钟有效期，过期自动清除
- 页面重新获得焦点时自动同步最新状态
- 支持手动清除无效状态

## 📋 测试步骤

### 基础测试
1. **安装插件**
   ```bash
   1. 打开Chrome浏览器
   2. 进入扩展程序管理页面 (chrome://extensions/)
   3. 开启"开发者模式"
   4. 点击"加载已解压的扩展程序"
   5. 选择插件目录
   ```

2. **基本功能测试**
   ```bash
   1. 访问雪球网站 (https://xueqiu.com)
   2. 点击插件图标打开控制面板
   3. 点击"开始爬取"启动爬虫
   4. 观察数据收集情况
   5. 点击"停止爬取"停止爬虫
   ```

### 状态持久化测试

#### 测试1: Tab切换状态保持
```bash
1. 在雪球页面启动爬虫
2. 切换到其他网站的tab
3. 再切换回雪球页面
4. 验证：
   - 插件按钮状态是否正确（显示"停止爬取"）
   - 数据计数是否保持
   - 爬虫是否继续运行
```

#### 测试2: 新Tab状态恢复
```bash
1. 在第一个雪球tab启动爬虫
2. 打开新的雪球页面tab
3. 在新tab中打开插件控制面板
4. 验证：
   - 新tab中插件状态是否与第一个tab一致
   - 数据计数是否同步
   - 按钮状态是否正确
```

#### 测试3: 浏览器重启恢复
```bash
1. 启动爬虫并收集一些数据
2. 关闭浏览器
3. 重新打开浏览器和雪球页面
4. 验证：
   - 状态是否在有效期内恢复
   - 数据是否保持
   - 爬虫是否自动恢复运行
```

#### 测试4: 状态过期处理
```bash
1. 启动爬虫
2. 等待5分钟以上
3. 打开新的雪球tab
4. 验证：
   - 过期状态是否被清除
   - 新tab是否显示初始状态
   - 不会自动恢复过期的爬虫状态
```

## 🛠 调试工具

### 使用测试页面
打开 `test.html` 文件可以：
- 检查Chrome存储中的状态数据
- 模拟各种爬虫状态
- 监控状态变化
- 清除存储状态

### 浏览器开发者工具
```javascript
// 在控制台中检查存储状态
chrome.storage.local.get(['crawlerState'], (result) => {
  console.log('当前状态:', result.crawlerState);
});

// 清除所有状态
chrome.storage.local.clear();

// 监听状态变化
chrome.storage.onChanged.addListener((changes, namespace) => {
  console.log('状态变化:', changes);
});
```

## 🔍 状态数据结构

```javascript
{
  crawlerState: {
    isRunning: boolean,        // 爬虫是否运行中
    collectedData: Array,      // 收集的数据数组
    currentPage: number,       // 当前页面数
    lastUpdate: timestamp      // 最后更新时间
  }
}
```

## ⚠️ 注意事项

1. **有效期限制**
   - 状态有效期为5分钟
   - 超过有效期的状态会被自动清除
   - 确保在有效期内完成tab切换测试

2. **网站限制**
   - 状态持久化仅在雪球网站 (xueqiu.com) 上生效
   - 在其他网站上插件会显示"请在雪球网站上使用"

3. **多实例处理**
   - 同时在多个tab运行爬虫可能导致状态冲突
   - 建议一次只在一个tab中运行爬虫
   - 其他tab会自动同步状态但不会重复运行

4. **数据安全**
   - 状态数据保存在本地Chrome存储中
   - 卸载插件会清除所有数据
   - 建议定期下载重要数据

## 🐛 故障排除

### 状态同步失败
```bash
解决方案：
1. 检查是否在雪球网站上
2. 刷新页面重新加载插件
3. 手动清除存储状态重新开始
4. 检查浏览器控制台错误信息
```

### 插件无响应
```bash
解决方案：
1. 重新加载插件扩展
2. 检查插件权限设置
3. 查看浏览器控制台错误
4. 确认网页已完全加载
```

### 数据丢失
```bash
解决方案：
1. 检查状态是否超过5分钟有效期
2. 确认是否意外清除了存储
3. 检查网络连接是否稳定
4. 验证雪球网站页面结构是否有变化
```

## 📊 性能优化

- 状态同步频率：每秒检查一次
- 存储更新：仅在状态变化时更新
- 内存使用：轻量级状态对象
- 网络请求：零额外网络开销

## 🔄 版本更新

当前版本特性：
- ✅ 基础DOM爬取功能
- ✅ 时间线项目展开
- ✅ 跨Tab状态持久化
- ✅ 自动状态恢复
- ✅ 状态有效期管理
- ✅ 多Tab状态同步

计划中的功能：
- 🔄 更智能的重复数据检测
- 🔄 批量数据导出格式选择
- 🔄 爬取进度可视化
- 🔄 自定义爬取规则
