# 雪球## ✨ 主要功能

### 🎯 核心爬取功能
- **自动爬取**: 智能爬取雪球用户时间线数据
- **DOM解析**: 基于页面元素的稳定数据提取
- **自动翻页**: 自动滚动加载更多内容
- **内容展开**: 自动点击展开按钮获取完整内容

### 🔄 状态持久化 (新功能)
- **跨Tab同步**: 在多个雪球标签页间保持状态一致
- **自动恢复**: 重新打开页面时自动恢复爬虫状态
- **智能状态管理**: 5分钟有效期，过期自动清理
- **实时同步**: 页面获得焦点时自动同步最新状态

### 📊 数据管理
- **实时统计**: 显示已爬取条数和页面数
- **数据导出**: 一键导出JSON格式数据
- **运行时间**: 显示爬取运行时长
- **状态监控**: 实时显示爬虫运行状态

## 🛠 安装指南

### 1. 下载插件文件
```bash
git clone <repository-url>
# 或直接下载zip文件并解压
```

### 2. 安装到Chrome
1. 打开Chrome浏览器
2. 进入扩展程序管理页面: `chrome://extensions/`
3. 开启右上角的"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择插件文件夹

### 3. 验证安装
- 工具栏应该出现插件图标
- 访问雪球网站时插件可用
- 控制台无错误信息

## 🎮 使用方法

### 基本操作
1. **打开雪球网站**: 访问 `https://xueqiu.com`
2. **启动插件**: 点击浏览器工具栏的插件图标
3. **开始爬取**: 点击"开始爬取"按钮
4. **监控进度**: 观察数据统计和运行状态
5. **停止爬取**: 需要时点击"停止爬取"
6. **导出数据**: 点击"下载数据"保存结果

### 高级功能
- **多Tab使用**: 可在多个雪球标签页中使用，状态自动同步
- **状态恢复**: 关闭重开页面时自动恢复之前的爬取状态
- **后台运行**: 切换到其他标签页时爬虫继续运行个强大的Chrome浏览器插件，用于自动爬取雪球网站的用户动态数据，支持跨标签页状态持久化。

## 功能特性

- 🚀 一键启动/停止爬虫
- � **网络请求拦截**: 拦截 `/v4/statuses/user_timeline.json` API 响应
- �📊 实时显示爬取进度和统计信息
- 🔄 自动翻页触发新的 API 请求
- 💾 完整保存 API 响应数据为 JSON 格式
- 🎯 智能去重机制防止重复数据
- ⏱️ 运行时间统计
- 📡 支持 XMLHttpRequest 和 Fetch 请求拦截

## 安装方法

1. 下载或克隆此项目到本地
2. 打开 Chrome 浏览器
3. 进入扩展程序管理页面 (`chrome://extensions/`)
4. 打开右上角的"开发者模式"
5. 点击"加载已解压的扩展程序"
6. 选择项目文件夹
7. 插件安装完成

## 使用方法

1. 访问雪球网站 (xueqiu.com)
2. 点击 Chrome 工具栏中的插件图标
3. 在弹出的面板中点击"开始爬虫"按钮
4. 插件会自动：
   - 点击 timeline__tab__tags 的第二个 a 标签
   - **拦截网络请求**: 自动捕获 `/v4/statuses/user_timeline.json` API 响应
   - 保存完整的 API 响应数据
   - 自动点击下一页继续拦截新的 API 请求
   - 直到没有更多页面为止
5. 爬取完成后，可以点击"下载数据"按钮导出完整的 API 响应数据

## 数据结构

导出的 JSON 文件包含完整的 API 响应信息：

```json
{
  "collectedAt": "2025-08-19T10:30:00.000Z",
  "totalItems": 150,
  "totalApiResponses": 5,
  "totalPages": 5,
  "apiResponses": [
    {
      "id": "api_1692443400000_abc123def",
      "timestamp": "2025-08-19T10:30:00.000Z",
      "pageNumber": 1,
      "apiUrl": "https://stock.xueqiu.com/v4/statuses/user_timeline.json?...",
      "responseData": {
        "statuses": [...],
        "next_cursor": "...",
        "previous_cursor": "..."
      },
      "items": [
        {
          "id": "status_id_123",
          "text": "动态内容文本",
          "user": {
            "id": "user_id",
            "screen_name": "用户名",
            "name": "显示名称",
            "profile_image_url": "头像URL"
          },
          "created_at": "2025-08-19T10:25:00.000Z",
          "source": "雪球网页版",
          "pic_urls": ["图片URL1", "图片URL2"],
          "raw_data": {...完整的原始状态数据...}
        }
      ]
    }
  ]
}
```

## 技术实现

- **Manifest V3**: 使用最新的 Chrome 扩展 API
- **网络请求拦截**: 拦截 XMLHttpRequest 和 Fetch API 请求
- **API 响应捕获**: 专门捕获 `/v4/statuses/user_timeline.json` 接口响应
- **Content Script**: 在页面中注入脚本，处理页面交互和请求拦截
- **Popup**: 提供用户操作界面
- **Background Service Worker**: 处理后台任务、网络监听和数据存储
- **智能去重**: 防止重复处理相同的 API 响应

## 🔧 调试和故障排除

### 如果爬虫一直显示"运行中"但没有数据

1. **打开浏览器开发者工具** (F12)
2. **切换到Console标签页**
3. **复制并运行debug-tool.js中的调试代码**
4. **查看输出结果**，找到问题所在

### 常见问题解决

**问题1: 已采集条目一直是0**
- 检查是否在正确的雪球页面上
- 查看Console是否有"拦截到时间线API响应"的日志
- 尝试手动刷新页面或滚动页面

**问题2: 找不到timeline tab**
- 检查页面上是否有timeline相关的标签页
- 可能页面结构发生了变化，需要更新选择器

**问题3: 网络请求没有被拦截**
- 确认页面确实发起了API请求（在Network标签页查看）
- 检查API URL是否匹配我们的拦截条件

### 手动调试步骤

1. **在控制台运行调试工具** (复制debug-tool.js内容)
2. **检查元素**: `debugXueqiuCrawler.checkElements()`
3. **测试网络拦截**: `debugXueqiuCrawler.testNetworkInterception()`
4. **手动启动**: `debugXueqiuCrawler.manualStart()`

## ⚠️ 注意事项

⚠️ **重要提醒**:
- 本插件仅供学习和研究使用
- 请遵守雪球网站的使用条款和 robots.txt
- 建议设置合理的爬取间隔，避免对服务器造成过大压力
- 请妥善保管爬取的数据，注意隐私保护

## 文件结构

```
xueqiu-tool/
├── manifest.json          # 插件配置文件
├── popup.html             # 弹窗界面
├── popup.js              # 弹窗逻辑
├── content.js            # 内容脚本 (主要爬虫逻辑)
├── background.js         # 后台服务
├── icons/                # 插件图标文件夹
└── README.md            # 说明文档
```

## 开发说明

如需修改或扩展功能：

1. **修改爬取逻辑**: 编辑 `content.js` 中的 `extractItemData` 方法
2. **调整界面**: 修改 `popup.html` 和相关 CSS
3. **添加新功能**: 在 `popup.js` 中添加新的控制逻辑
4. **修改存储**: 在 `background.js` 中调整数据持久化逻辑

## 版本历史

- v1.0: 初始版本，支持基本的数据爬取和导出功能

## 许可证

MIT License - 仅供学习使用
