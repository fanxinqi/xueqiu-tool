<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›ªçƒæ’ä»¶çŠ¶æ€æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ é›ªçƒçˆ¬è™«æ’ä»¶çŠ¶æ€æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªé¡µé¢å¸®åŠ©æµ‹è¯•Chromeæ’ä»¶çš„çŠ¶æ€æŒä¹…åŒ–åŠŸèƒ½ï¼š</p>
            <ol>
                <li>åœ¨é›ªçƒç½‘ç«™å¼€å¯çˆ¬è™«</li>
                <li>åˆ‡æ¢åˆ°å…¶ä»–tabåå†å›æ¥</li>
                <li>æ£€æŸ¥çŠ¶æ€æ˜¯å¦ä¿æŒä¸€è‡´</li>
                <li>æµ‹è¯•å¤štabä¹‹é—´çš„çŠ¶æ€åŒæ­¥</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ” å½“å‰çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkExtensionStatus()">æ£€æŸ¥æ’ä»¶çŠ¶æ€</button>
            <button onclick="checkStorageState()">æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>
            <button onclick="clearStorageState()">æ¸…é™¤å­˜å‚¨çŠ¶æ€</button>
            <div id="statusDisplay" class="status warning">
                ç‚¹å‡»æŒ‰é’®æ£€æŸ¥çŠ¶æ€...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª çŠ¶æ€æµ‹è¯•å·¥å…·</h3>
            <button onclick="simulateCrawlerState(true)">æ¨¡æ‹Ÿçˆ¬è™«å¯åŠ¨</button>
            <button onclick="simulateCrawlerState(false)">æ¨¡æ‹Ÿçˆ¬è™«åœæ­¢</button>
            <button onclick="addTestData()">æ·»åŠ æµ‹è¯•æ•°æ®</button>
            <button onclick="checkTabSync()">æ£€æŸ¥TabåŒæ­¥</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š çŠ¶æ€æ•°æ®</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <strong>è¿è¡ŒçŠ¶æ€:</strong> <span id="runningStatus">-</span><br>
                    <strong>æ•°æ®æ¡æ•°:</strong> <span id="dataCount">-</span><br>
                    <strong>å½“å‰é¡µé¢:</strong> <span id="currentPage">-</span>
                </div>
                <div>
                    <strong>æœ€åæ›´æ–°:</strong> <span id="lastUpdate">-</span><br>
                    <strong>çŠ¶æ€æœ‰æ•ˆæ€§:</strong> <span id="stateValidity">-</span><br>
                    <strong>Tab ID:</strong> <span id="tabId">-</span>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div id="logDisplay" class="log">
                ç­‰å¾…æ“ä½œ...
            </div>
        </div>
    </div>

    <script>
        let logContainer = document.getElementById('logDisplay');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            logContainer.innerHTML = 'æ—¥å¿—å·²æ¸…é™¤';
        }

        async function checkExtensionStatus() {
            log('æ£€æŸ¥æ’ä»¶çŠ¶æ€...');
            try {
                // è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…éœ€è¦é€šè¿‡Chrome Extension API
                log('âš ï¸ è¿™æ˜¯æµ‹è¯•é¡µé¢ï¼Œéœ€è¦åœ¨é›ªçƒç½‘ç«™ä¸Šæµ‹è¯•çœŸå®åŠŸèƒ½', 'warning');
                updateStatusDisplay('æµ‹è¯•æ¨¡å¼ - è¯·åœ¨é›ªçƒç½‘ç«™æµ‹è¯•', 'warning');
            } catch (error) {
                log(`æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatusDisplay('æ£€æŸ¥å¤±è´¥', 'error');
            }
        }

        async function checkStorageState() {
            log('æ£€æŸ¥Chromeå­˜å‚¨çŠ¶æ€...');
            try {
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    const result = await chrome.storage.local.get(['crawlerState']);
                    if (result.crawlerState) {
                        const state = result.crawlerState;
                        updateStateDisplay(state);
                        log('âœ… æˆåŠŸè¯»å–å­˜å‚¨çŠ¶æ€', 'success');
                        updateStatusDisplay('å­˜å‚¨çŠ¶æ€å·²è¯»å–', 'success');
                    } else {
                        log('âš ï¸ æœªæ‰¾åˆ°å­˜å‚¨çŠ¶æ€', 'warning');
                        updateStatusDisplay('æœªæ‰¾åˆ°å­˜å‚¨çŠ¶æ€', 'warning');
                    }
                } else {
                    log('âš ï¸ Chromeå­˜å‚¨APIä¸å¯ç”¨', 'warning');
                    updateStatusDisplay('Chrome APIä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                log(`è¯»å–å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
                updateStatusDisplay('è¯»å–å¤±è´¥', 'error');
            }
        }

        async function clearStorageState() {
            log('æ¸…é™¤å­˜å‚¨çŠ¶æ€...');
            try {
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    await chrome.storage.local.remove(['crawlerState']);
                    log('âœ… å­˜å‚¨çŠ¶æ€å·²æ¸…é™¤', 'success');
                    updateStatusDisplay('å­˜å‚¨çŠ¶æ€å·²æ¸…é™¤', 'success');
                    clearStateDisplay();
                } else {
                    log('âš ï¸ Chromeå­˜å‚¨APIä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                log(`æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
                updateStatusDisplay('æ¸…é™¤å¤±è´¥', 'error');
            }
        }

        async function simulateCrawlerState(running) {
            log(`æ¨¡æ‹Ÿçˆ¬è™«${running ? 'å¯åŠ¨' : 'åœæ­¢'}...`);
            try {
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    const state = {
                        isRunning: running,
                        collectedData: running ? [
                            { id: 1, content: 'æµ‹è¯•æ•°æ®1', time: Date.now() },
                            { id: 2, content: 'æµ‹è¯•æ•°æ®2', time: Date.now() }
                        ] : [],
                        currentPage: running ? 1 : 0,
                        lastUpdate: Date.now()
                    };
                    
                    await chrome.storage.local.set({ crawlerState: state });
                    updateStateDisplay(state);
                    log(`âœ… çˆ¬è™«çŠ¶æ€è®¾ç½®ä¸º: ${running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}`, 'success');
                    updateStatusDisplay(`æ¨¡æ‹ŸçŠ¶æ€: ${running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}`, 'success');
                } else {
                    log('âš ï¸ Chromeå­˜å‚¨APIä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                log(`æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error');
                updateStatusDisplay('æ¨¡æ‹Ÿå¤±è´¥', 'error');
            }
        }

        async function addTestData() {
            log('æ·»åŠ æµ‹è¯•æ•°æ®...');
            try {
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    const result = await chrome.storage.local.get(['crawlerState']);
                    let state = result.crawlerState || {
                        isRunning: false,
                        collectedData: [],
                        currentPage: 0,
                        lastUpdate: Date.now()
                    };
                    
                    state.collectedData.push({
                        id: Date.now(),
                        content: `æµ‹è¯•æ•°æ® ${state.collectedData.length + 1}`,
                        time: Date.now()
                    });
                    state.lastUpdate = Date.now();
                    
                    await chrome.storage.local.set({ crawlerState: state });
                    updateStateDisplay(state);
                    log(`âœ… æ·»åŠ æµ‹è¯•æ•°æ®ï¼Œæ€»è®¡: ${state.collectedData.length}æ¡`, 'success');
                    updateStatusDisplay('æµ‹è¯•æ•°æ®å·²æ·»åŠ ', 'success');
                } else {
                    log('âš ï¸ Chromeå­˜å‚¨APIä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                log(`æ·»åŠ æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                updateStatusDisplay('æ·»åŠ æ•°æ®å¤±è´¥', 'error');
            }
        }

        async function checkTabSync() {
            log('æ£€æŸ¥TabåŒæ­¥åŠŸèƒ½...');
            updateStatusDisplay('è¯·åœ¨é›ªçƒç½‘ç«™å¤šä¸ªtabä¸­æµ‹è¯•', 'warning');
            log('â„¹ï¸ TabåŒæ­¥åŠŸèƒ½éœ€è¦åœ¨é›ªçƒç½‘ç«™çš„å¤šä¸ªæ ‡ç­¾é¡µä¸­æµ‹è¯•');
            log('1. åœ¨ç¬¬ä¸€ä¸ªtabå¯åŠ¨çˆ¬è™«');
            log('2. æ‰“å¼€æ–°çš„é›ªçƒtab');
            log('3. æ£€æŸ¥æ–°tabä¸­æ’ä»¶çŠ¶æ€æ˜¯å¦åŒæ­¥');
        }

        function updateStatusDisplay(message, type) {
            const statusDiv = document.getElementById('statusDisplay');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateStateDisplay(state) {
            document.getElementById('runningStatus').textContent = state.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            document.getElementById('dataCount').textContent = state.collectedData ? state.collectedData.length : 0;
            document.getElementById('currentPage').textContent = state.currentPage || 0;
            
            const lastUpdate = new Date(state.lastUpdate);
            document.getElementById('lastUpdate').textContent = lastUpdate.toLocaleString();
            
            const now = Date.now();
            const isValid = (now - state.lastUpdate) < 5 * 60 * 1000;
            document.getElementById('stateValidity').textContent = isValid ? 'æœ‰æ•ˆ' : 'å·²è¿‡æœŸ';
            document.getElementById('stateValidity').style.color = isValid ? '#28a745' : '#dc3545';
        }

        function clearStateDisplay() {
            document.getElementById('runningStatus').textContent = '-';
            document.getElementById('dataCount').textContent = '-';
            document.getElementById('currentPage').textContent = '-';
            document.getElementById('lastUpdate').textContent = '-';
            document.getElementById('stateValidity').textContent = '-';
            document.getElementById('stateValidity').style.color = '#333';
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ çŠ¶æ€æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('è¯·åœ¨é›ªçƒç½‘ç«™ (xueqiu.com) ä¸Šæµ‹è¯•çœŸå®åŠŸèƒ½');
            
            // å°è¯•è·å–å½“å‰tabä¿¡æ¯
            if (typeof chrome !== 'undefined' && chrome.tabs) {
                chrome.tabs.query({active: true, currentWindow: true}, (tabs) => {
                    if (tabs[0]) {
                        document.getElementById('tabId').textContent = tabs[0].id;
                    }
                });
            }
        });

        // ç›‘å¬å­˜å‚¨å˜åŒ–
        if (typeof chrome !== 'undefined' && chrome.storage) {
            chrome.storage.onChanged.addListener((changes, namespace) => {
                if (changes.crawlerState) {
                    log('ğŸ”„ æ£€æµ‹åˆ°å­˜å‚¨çŠ¶æ€å˜åŒ–');
                    if (changes.crawlerState.newValue) {
                        updateStateDisplay(changes.crawlerState.newValue);
                    } else {
                        clearStateDisplay();
                    }
                }
            });
        }
    </script>
</body>
</html>
