# 雪球爬虫Chrome插件 🚀

一个强大的Chrome浏览器插件，用于自动爬取雪球网站的用户动态数据，支持跨标签页状态持久化。

## ✨ 主要功能

### 🎯 核心爬取功能
- **自动爬取**: 智能爬取雪球用户时间线数据
- **DOM解析**: 基于页面元素的稳定数据提取
- **自动翻页**: 自动滚动加载更多内容
- **内容展开**: 自动点击展开按钮获取完整内容

### 🔄 状态持久化 (新功能)
- **跨Tab同步**: 在多个雪球标签页间保持状态一致
- **自动恢复**: 重新打开页面时自动恢复爬虫状态
- **智能状态管理**: 5分钟有效期，过期自动清理
- **实时同步**: 页面获得焦点时自动同步最新状态

### 📊 数据管理
- **实时统计**: 显示已爬取条数和页面数
- **数据导出**: 一键导出JSON格式数据
- **运行时间**: 显示爬取运行时长
- **状态监控**: 实时显示爬虫运行状态

## 🛠 安装指南

### 1. 下载插件文件
```bash
git clone <repository-url>
# 或直接下载zip文件并解压
```

### 2. 安装到Chrome
1. 打开Chrome浏览器
2. 进入扩展程序管理页面: `chrome://extensions/`
3. 开启右上角的"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择插件文件夹

### 3. 验证安装
- 工具栏应该出现插件图标
- 访问雪球网站时插件可用
- 控制台无错误信息

## 🎮 使用方法

### 基本操作
1. **打开雪球网站**: 访问 `https://xueqiu.com`
2. **启动插件**: 点击浏览器工具栏的插件图标
3. **开始爬取**: 点击"开始爬取"按钮
4. **监控进度**: 观察数据统计和运行状态
5. **停止爬取**: 需要时点击"停止爬取"
6. **导出数据**: 点击"下载数据"保存结果

### 高级功能
- **多Tab使用**: 可在多个雪球标签页中使用，状态自动同步
- **状态恢复**: 关闭重开页面时自动恢复之前的爬取状态
- **后台运行**: 切换到其他标签页时爬虫继续运行

## 📱 界面说明

### 控制面板
```
┌─────────────────────────┐
│     🚀 雪球数据爬虫      │
├─────────────────────────┤
│ 状态: ●运行中           │
│ 数据: 150条             │
│ 页面: 15页              │
│ 时间: 02:30:45          │
├─────────────────────────┤
│ [停止爬取] [下载数据]    │
└─────────────────────────┘
```

### 状态指示
- **🟢 运行中**: 爬虫正在活跃爬取数据
- **🔴 已停止**: 爬虫已停止，可查看和下载数据
- **🟡 连接中**: 正在初始化或重新连接
- **⚫ 未激活**: 请在雪球网站上使用

## 🔧 技术特性

### 插件架构
- **Manifest V3**: 使用最新的Chrome扩展标准
- **Content Script**: 主要爬取逻辑
- **Popup Interface**: 用户控制界面
- **Background Service**: 后台服务支持

### 状态管理
- **Chrome Storage API**: 使用浏览器原生存储
- **状态有效期**: 5分钟自动过期机制
- **跨Tab同步**: 实时状态同步算法
- **智能恢复**: 页面焦点检测和状态恢复

### 数据处理
- **CSS选择器**: 精确的元素定位
- **去重机制**: 避免重复数据收集
- **错误处理**: 完善的异常捕获和恢复
- **性能优化**: 最小化内存和CPU使用

## 📋 测试指南

### 基础功能测试
```bash
1. 安装插件并访问雪球网站
2. 启动爬虫，验证数据收集
3. 检查自动翻页和内容展开
4. 验证数据导出功能
```

### 状态持久化测试
```bash
1. Tab切换测试:
   - 启动爬虫 → 切换Tab → 返回检查状态

2. 新Tab恢复测试:
   - 在Tab1启动爬虫 → 打开新雪球Tab → 检查状态同步

3. 浏览器重启测试:
   - 启动爬虫 → 关闭浏览器 → 重新打开检查恢复

4. 状态过期测试:
   - 启动爬虫 → 等待5分钟 → 检查状态清理
```

### 使用测试工具
打开 `test.html` 进行高级测试：
- Chrome存储状态检查
- 模拟各种爬虫状态
- 监控状态变化日志
- 手动清除存储状态

## 🐛 故障排除

### 常见问题

**Q: 插件图标灰色无法点击**
```
A: 请确保在雪球网站 (xueqiu.com) 上使用插件
```

**Q: 爬虫启动失败**
```
A: 1. 刷新页面重试
   2. 检查网络连接
   3. 确认页面完全加载
   4. 重新加载插件扩展
```

**Q: 状态同步失败**
```
A: 1. 检查是否在雪球网站
   2. 手动清除存储状态
   3. 重新启动爬虫
   4. 检查浏览器控制台错误
```

**Q: 数据导出为空**
```
A: 1. 确认已收集到数据 (数据计数 > 0)
   2. 检查浏览器下载设置
   3. 尝试刷新页面重新导出
```

### 调试工具

**浏览器控制台命令**:
```javascript
// 检查存储状态
chrome.storage.local.get(['crawlerState'], console.log);

// 清除所有状态
chrome.storage.local.clear();

// 监听状态变化
chrome.storage.onChanged.addListener(console.log);
```

## 📊 性能指标

- **内存使用**: < 10MB
- **CPU占用**: < 5% (爬取时)
- **状态同步延迟**: < 1秒
- **数据处理速度**: ~100条/分钟
- **存储空间**: 每1000条数据约1MB

## ⚠️ 注意事项

### 使用限制
- 仅支持雪球网站 (xueqiu.com)
- 需要开启"开发者模式"安装
- 状态有效期限制为5分钟
- 建议单个标签页运行爬虫

### 数据安全
- 数据保存在本地浏览器存储
- 不会上传到任何服务器
- 卸载插件会清除所有数据
- 建议及时导出重要数据

### 法律声明
- 请遵守雪球网站的使用条款
- 数据仅供个人学习研究使用
- 不得用于商业用途
- 使用者承担相应法律责任

## 🔄 版本历史

### v2.0.0 (当前版本)
- ✅ 新增跨Tab状态持久化功能
- ✅ 智能状态同步和恢复机制
- ✅ 页面焦点检测和状态更新
- ✅ 5分钟状态有效期管理
- ✅ 完善的错误处理和恢复

### v1.0.0 (基础版本)
- ✅ 基础DOM爬取功能
- ✅ 自动时间线项目展开
- ✅ 自动翻页和数据收集
- ✅ 数据统计和导出功能
- ✅ 简洁的用户界面

## 📝 开发计划

### 近期计划
- 🔄 智能重复数据检测
- 🔄 多种数据导出格式
- 🔄 爬取进度可视化
- 🔄 自定义爬取规则

### 长期计划
- 🔄 多网站支持
- 🔄 云端数据同步
- 🔄 数据分析功能
- 🔄 API接口支持

## 📞 技术支持

- **文档**: 查看 `STATE_PERSISTENCE_GUIDE.md` 详细说明
- **测试**: 使用 `test.html` 进行功能测试
- **问题**: 检查浏览器控制台错误信息
- **调试**: 使用开发者工具进行深度调试

---

*如有问题或建议，请通过GitHub Issues反馈。*
